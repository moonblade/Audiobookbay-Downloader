<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audiobook Search</title>
    <link rel="icon" href="/static/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        /* Style for the progress bar */
        .progress-bar {
            height: 1rem; /* Adjust height as needed */
            background-color: #e2e8f0; /* Light gray background */
            border-radius: 0.5rem; /* Rounded corners */
            overflow: hidden; /* Hide overflow of the filled part */
        }

        .progress-bar-fill {
            height: 100%;
            background-color: #4ade80; /* Green fill color */
            border-radius: 0.5rem;
            width: 0%; /* Initial width */
            transition: width 0.5s ease-in-out; /* Smooth transition */
        }
    </style>
</head>
<body class="bg-gray-800 text-white p-6" x-data="{
    query: '',
    results: [],
    loadingSearch: false,
    searchComplete: false,
    searchError: '',
    funnyMessages: [
        'Searching... This better be worth it!',
        'Hold on, this takes a while...',
        'Still searching... Maybe grab a snack?',
        'Patience, young grasshopper...',
        'Wow, this is taking a minute!',
        'Donâ€™t worry, I got this!',
        'Maybe go for a walk?',
        'Still thinking... Almost there!',
        'Finding the best results for you!',
        'Hang tight! Searching magic happening!',
        'One moment... while I consult the ancients.',
        'Beep boop... processing... please wait...',
        'My hamsters are running on a wheel, almost there!',
        'Just gathering some pixie dust, be right back!',
        'Is it lunchtime yet? Oh, searching... right.',
        'Please remain calm, the search is in progress.',
        'Warning: Search may cause extreme awesomeness.',
        'Calculating the optimal route to your results...',
        'Almost there... just defragmenting my brain.',
        'Searching... because the internet is a big place!'
    ],
    currentFunnyMessage: '',
    messageInterval: null,
    
    async search() {
        if (!this.query) return;
        this.loadingSearch = true;
        this.searchComplete = false;
        this.searchError = '';
        this.results = [];
        const shuffledMessages = [...this.funnyMessages].sort(() => Math.random() - 0.5);

        // Start funny messages loop
        let index = 0;
        this.messageInterval = setInterval(() => {
            this.currentFunnyMessage = shuffledMessages[index % shuffledMessages.length];
            index++;
        }, 5000);

        try {
            let response = await fetch(`/search?query=${encodeURIComponent(this.query)}`);
            if (!response.ok) throw new Error('Failed to fetch results');
            let data = await response.json();
            this.results = data.results || [];
        } catch (error) {
            this.searchError = error.message;
        } finally {
            this.searchComplete = true;
            this.loadingSearch = false;
            clearInterval(this.messageInterval);
            this.currentFunnyMessage = '';
        }
    },

    loadingAdd: {},
    addError: {},
    
    async add(url) {
        this.loadingAdd[url] = true;
        this.addError[url] = '';
        this.searchError = '';

        
        try {
            let response = await fetch('/add', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ url })
            });
            let data = await response.json();
            if (data.status !== 'ok') throw new Error(data.message || 'Error adding torrent');
            this.searchComplete = false;
            this.searchError = 'Successfully added torrent. You can search for more audiobooks!';
        } catch (error) {
            this.addError[url] = error.message;
        } finally {
            this.loadingAdd[url] = false;
        }
    },

    async keydown(event) {
      this.searchComplete = false;
    },

    torrentStatus: [],
    loadingTorrentStatus: false,

    async getTorrentStatus() {
        this.loadingTorrentStatus = true;
        try {
            const response = await fetch('/list'); // Call your /list endpoint
            if (!response.ok) {
                throw new Error('Failed to fetch torrent status');
            }
            const data = await response.json();
            this.torrentStatus = data;
        } catch (error) {
            console.error(error); // Handle error as needed
        } finally {
            this.loadingTorrentStatus = false;
        }
    }
}" x-init="getTorrentStatus">
    <div class="max-w-3xl mx-auto mt-6" x-show="torrentStatus.length">
        <h2 class="text-2xl font-bold mb-4">Torrent Status</h2>
        <template x-for="torrent in torrentStatus" :key="torrent.id">
            <div class="bg-gray-700 p-4 rounded shadow mb-2">
                <h3 class="font-bold" x-text="torrent.name"></h3>
                <p class="text-sm text-gray-400">Status: <span x-text="torrent.status"></span></p>
                <div class="progress-bar">
                    <div class="progress-bar-fill" :style="{ width: torrent.percent_done + '%' }"></div>
                </div>
                <p class="text-sm text-gray-400">
                    Completed: <span x-text="(torrent.downloaded_ever / 1024 / 1024).toFixed(2)"></span> MB /
                    Total: <span x-text="(torrent.total_size / 1024 / 1024).toFixed(2)"></span> MB
                </p>
            </div>
        </template>
        <p x-show="loadingTorrentStatus" class="text-center text-gray-400">Loading torrent status...</p>
    </div>
    <div class="max-w-xl mx-auto bg-gray-700 p-6 rounded shadow">
        <h1 class="text-2xl font-bold mb-4">Audiobook Search</h1>
        <div class="flex gap-2">
            <input type="text" x-model="query" @input="keydown" @keydown.enter="search" class="border p-2 flex-grow rounded bg-gray-600 text-white" placeholder="Search for audiobooks...">
            <button @click="search" :disabled="loadingSearch" class="bg-blue-600 text-white px-4 py-2 rounded flex items-center gap-2 disabled:opacity-50">
                <span x-show="loadingSearch" class="animate-spin border-2 border-white border-t-transparent rounded-full w-4 h-4"></span>
                Search
            </button>
        </div>
        <p x-show="searchError" class="text-red-500 mt-2" x-text="searchError"></p>
        <p x-show="loadingSearch" class="text-gray-400 mt-2 italic" x-text="currentFunnyMessage"></p>
    </div>

    <div class="max-w-xl mx-auto mt-6" x-show="results.length">
        <template x-for="result in results" :key="result.Guid">
            <div class="bg-gray-700 p-4 rounded shadow mb-2 flex items-center gap-4">
                <img :src="result.Poster" class="w-16 h-16 object-cover rounded">
                <div class="flex-grow">
                    <h2 class="font-bold" x-text="result.Title"></h2>
                    <p class="text-sm text-gray-400">Size: <span x-text="(result.Size / 1024 / 1024 / 1024).toFixed(2) + ' GB'"></span></p>
                </div>
                <button @click="add(result.Link)" :disabled="loadingAdd[result.Link]==true" class="bg-green-600 text-white px-3 py-1 rounded flex items-center gap-2 disabled:opacity-50">
                    <span x-show="loadingAdd[result.Link]" class="animate-spin border-2 border-white border-t-transparent rounded-full w-4 h-4"></span>
                    Add
                </button>
            </div>
            <p x-show="addError[result.Link]" class="text-red-500 text-sm mt-1" x-text="addError[result.Link]"></p>
        </template>
    </div>

    <p class="max-w-xl mx-auto mt-6 text-center text-gray-400" x-show="searchComplete && results.length === 0 && query">No results found. Try a different search term!</p>
</body>
</html>
